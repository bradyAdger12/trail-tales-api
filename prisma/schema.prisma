generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DB_URL")
}

enum Unit {
  metric
  imperial
}

enum Resource {
  food
  water
  health
}

enum GameDifficulty {
  easy
  medium
  hard
}

enum GameStatus {
  active
  won
  lost
}

enum DayDifficulty {
  easy
  medium
  hard
  rest
}

model User {
  id                   String        @id @default(uuid())
  email                String        @unique
  display_name         String?       @unique
  hashed_password      String
  unit                 Unit          @default(imperial)
  timezone             String        @default("America/Denver")
  avatar_file_key      String?
  google_id            String?       @unique
  strava_access_token  String?
  strava_refresh_token String?
  strava_owner_id      Int?
  created_at           DateTime      @default(now())
  updated_at           DateTime      @default(now())
  activities           Activity[]
  Game                 Game?
  SurvivalDay          SurvivalDay[]
  character            Character?

  @@map("users")
}

model Activity {
  id                      String       @id @default(uuid())
  user_id                 String
  source                  String
  source_id               String       @unique
  source_created_at       DateTime     @default(now())
  polyline                String
  name                    String
  description             String?
  distance_series         Float[]
  time_series             Int[]
  distance_in_meters      Float
  elapsed_time_in_seconds Float
  created_at              DateTime     @default(now())
  updated_at              DateTime     @default(now())
  user                    User         @relation(fields: [user_id], references: [id], onDelete: Cascade)
  survival_day            SurvivalDay?

  @@map("activities")
}

model Character {
  id         String   @id @default(uuid())
  game_id    String   @unique
  user_id    String   @unique
  health     Int      @default(100)
  food       Int      @default(1)
  water      Int      @default(1)
  created_at DateTime @default(now())
  updated_at DateTime @default(now())
  game       Game     @relation(fields: [game_id], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("characters")
}

model Game {
  id                         String         @id @default(uuid())
  difficulty                 GameDifficulty
  user_id                    String         @unique
  status                     GameStatus     @default(active)
  created_at                 DateTime       @default(now())
  updated_at                 DateTime       @default(now())
  daily_food_loss            Int            @default(10)
  daily_water_loss           Int            @default(10)
  min_duration_in_seconds    Int?           @default(20)
  max_duration_in_seconds    Int?           @default(30)
  user                       User           @relation(fields: [user_id], references: [id], onDelete: Cascade)
  survival_days              SurvivalDay[]
  character                  Character?
  game_notifications         GameNotification[]
  @@map("games")
}

model GameNotification {
  id String @id @default(uuid())
  game_id String
  description String
  day Int
  seen Boolean @default(false)
  resource Resource
  resource_change_as_percent Int
  created_at DateTime @default(now())
  updated_at DateTime @default(now())
  game Game @relation(fields: [game_id], references: [id], onDelete: Cascade)
  @@map("game_notifications")
}

model SurvivalDay {
  id                   String              @id @default(uuid())
  game_id              String
  user_id              String
  activity_id          String?             @unique
  completed_difficulty DayDifficulty?
  day                  Int
  created_at           DateTime            @default(now())
  updated_at           DateTime            @default(now())
  activity             Activity?           @relation(fields: [activity_id], references: [id], onDelete: SetNull)
  user                 User                @relation(fields: [user_id], references: [id], onDelete: Cascade)
  game                 Game                @relation(fields: [game_id], references: [id], onDelete: Cascade)
  options              SurvivalDayOption[]
  @@map("survival_days")
}

model SurvivalDayOption {
  id                       String        @id @default(uuid())
  difficulty               DayDifficulty
  survival_day_id          String
  description              String
  food_gain_percentage     Int           @default(5)
  water_gain_percentage    Int           @default(5)
  health_gain_percentage   Int           @default(5)
  duration_in_seconds      Int           @default(20)
  created_at               DateTime      @default(now())
  updated_at               DateTime      @default(now())
  survival_day             SurvivalDay   @relation(fields: [survival_day_id], references: [id], onDelete: Cascade)

  @@map("survival_day_options")
}

model PasswordResetToken {
  id          String   @default(uuid())
  user_id     String
  token       String
  expiry_time DateTime @default(now())
  created_at  DateTime @default(now())

  @@id([user_id, token])
  @@map("password_reset_tokens")
}
